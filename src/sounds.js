let zzfx, zzfxP, zzfxG, zzfxM, zzfxV, zzfxR, zzfxX

// zzfx() - the universal entry point -- returns a AudioBufferSourceNode
zzfx=(...t)=>zzfxP(zzfxG(...t));

// zzfxP() - the sound player -- returns a AudioBufferSourceNode
zzfxP=(...t)=>{let e=zzfxX.createBufferSource(),f=zzfxX.createBuffer(t.length,t[0].length,zzfxR);t.map((d,i)=>f.getChannelData(i).set(d)),e.buffer=f,e.connect(zzfxX.destination),e.start();return e}

// zzfxG() - the sound generator -- returns an array of sample data
zzfxG=(q=1,k=.05,c=220,e=0,t=0,u=.1,r=0,F=1,v=0,z=0,w=0,A=0,l=0,B=0,x=0,G=0,d=0,y=1,m=0,C=0)=>{let b=2*Math.PI,H=v*=500*b/zzfxR**2,I=(0<x?1:-1)*b/4,D=c*=(1+2*k*Math.random()-k)*b/zzfxR,Z=[],g=0,E=0,a=0,n=1,J=0,K=0,f=0,p,h;e=99+zzfxR*e;m*=zzfxR;t*=zzfxR;u*=zzfxR;d*=zzfxR;z*=500*b/zzfxR**3;x*=b/zzfxR;w*=b/zzfxR;A*=zzfxR;l=zzfxR*l|0;for(h=e+m+t+u+d|0;a<h;Z[a++]=f)++K%(100*G|0)||(f=r?1<r?2<r?3<r?Math.sin((g%b)**3):Math.max(Math.min(Math.tan(g),1),-1):1-(2*g/b%2+2)%2:1-4*Math.abs(Math.round(g/b)-g/b):Math.sin(g),f=(l?1-C+C*Math.sin(2*Math.PI*a/l):1)*(0<f?1:-1)*Math.abs(f)**F*q*zzfxV*(a<e?a/e:a<e+m?1-(a-e)/m*(1-y):a<e+m+t?y:a<h-d?(h-a-d)/u*y:0),f=d?f/2+(d>a?0:(a<h-d?1:(h-a)/d)*Z[a-d|0]/2):f),p=(c+=v+=z)*Math.sin(E*x-I),g+=p-p*B*(1-1E9*(Math.sin(a)+1)%2),E+=p-p*B*(1-1E9*(Math.sin(a)**2+1)%2),n&&++n>A&&(c+=w,D+=w,n=0),!l||++J%l||(c=D,v=H,n=n||1);return Z}

// zzfxV - global volume
zzfxV=.3

// zzfxR - global sample rate
zzfxR=44100

// zzfxX - the common audio context
zzfxX=new(top.AudioContext||webkitAudioContext);

zzfxM=(n,f,t,e=125)=>{let l,o,z,r,g,h,x,a,u,c,d,i,m,p,G,M=0,R=[],b=[],j=[],k=0,q=0,s=1,v={},w=zzfxR/e*60>>2;for(;s;k++)R=[s=a=d=m=0],t.map((e,d)=>{for(x=f[e][k]||[0,0,0],s|=!!f[e][k],G=m+(f[e][0].length-2-!a)*w,p=d==t.length-1,o=2,r=m;o<x.length+p;a=++o){for(g=x[o],u=o==x.length+p-1&&p||c!=(x[0]||0)|g|0,z=0;z<w&&a;z++>w-99&&u?i+=(i<1)/99:0)h=(1-i)*R[M++]/2||0,b[r]=(b[r]||0)-h*q+h,j[r]=(j[r++]||0)+h*q+h;g&&(i=g%1,q=x[1]||0,(g|=0)&&(R=v[[c=x[M=0]||0,g]]=v[[c,g]]||(l=[...n[c]],l[2]*=2**((g-12)/12),g>0?zzfxG(...l):[])))}m=G});return[b,j]}


export class SoundEffects {
  coin() {
	zzfx(...[,,1300,,.05,.5,1,2,,,1300,.07,,,.1,,,.9]);
  }

  impact() {
	zzfx(...[,,200,,.02,.11,,5,,-0.1,600,.3,,8,,,,.9,0.1,.01]);
  }

  impact_foe() {
	zzfx(...[,,420,,.02,.2,4,1.05,-9,,2e3,.5,,,,.5]);
  }
}

const intro = [[[.9,0,143,,.1,.5,3],[2,0,4e3,,,.05,2,1.25,,,,,.02,6.8,-.3,,.5],[3,0,43,,.16,.3,,,,,,,,2]],[[[,,13,,,,13,,13,,,,,,,,,,13,,,,13,,13,,,,6,,10,,12,,13,,,,13,,13,,,,,,,,,,8,,,,8,,8,,,,,,,,,,],[,,17,,,,17,,17,,,,,,,,,,17,,,,17,,17,,,,,,,,,,17,,,,17,,17,,,,,,,,,,12,,,,12,,12,,,,,,,,,,],[,,22,,,,22,,22,,,,,,,,,,22,,,,22,,22,,,,,,,,,,22,,,,22,,22,,,,,,,,,,17,,,,17,,17,,,,,,,,,,],[1,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,]],[[,,13,,,,13,,13,,,,,,,,,,13,,,,13,,13,,,,6,,10,,12,,13,,,,13,,13,,,,,,,,,,8,,,,8,,8,,,,,,,,,,],[,,17,,,,17,,17,,,,,,,,,,17,,,,17,,17,,,,,,,,,,17,,,,17,,17,,,,,,,,,,12,,,,12,,12,,,,,,,,,,],[,,22,,,,22,,22,,,,,,,,,,22,,,,22,,22,,,,,,,,,,22,,,,22,,22,,,,,,,,,,17,,,,17,,17,,,,,,,,,,],[1,,,,,,,,,,13,13,,13,,,13,,,,,,,,,,13,,13,,13,,13,,,,,,,,,,,,13,,,,13,,,,,,,,,,13,13,,13,13,,13,13]],[[,,13,,,,13,,13,,,,,,,,,,13,,,,13,,13,,,,6,,10,,12,,13,,,,13,,13,,,,,,10,,,,8,,,,8,,8,,,,,,,,,,],[,,17,,,,17,,17,,,,,,,,,,17,,,,17,,17,,,,,,,,,,17,,,,17,,17,,,,,,13,,,,12,,,,12,,12,,,,,,,,,,],[,,22,,,,22,,22,,,,5,,10,,12,,22,,,,22,,22,,,,12,,10,,5,,22,,,,22,,22,,,,,,18,,,,17,,,,17,,6,,,,,,,,,,],[1,,,,,,,,,,13,13,,13,,,13,,,,,,,,,,13,,13,,13,,13,,,,,,,,,,,,13,,,,13,,,,,,,,,,13,13,,13,13,,13,13],[2,,13,,,,,,,,13,,,,,,,,13,,,,,,,,13,,,,,,,,13,,,,,,,,13,,,,,,,,13,,,,,,,,13,,,,,,,,]],[[,,13,,,,13,,13,,,,12,,10,,5,,13,,,,13,,13,,,,6,,10,,12,,13,,,,13,,13,,,,,,10,,,,8,,,,8,,8,,,,,,13,,,,],[,,17,,,,17,,17,,,,,,,,,,17,,,,17,,17,,,,,,,,,,17,,,,17,,17,,,,,,13,,,,12,,,,12,,12,,,,,,,,,,],[,,22,,,,22,,22,,,,5,,10,,12,,22,,,,22,,22,,,,12,,12,,5,,22,,,,22,,22,,,,,,18,,,,17,,,,17,,6,,,,,,,,,,],[1,,,,,,,,,,13,13,,13,,,13,,,,,,,,,,13,,13,,13,,13,,,,,,,,,,,,13,,,,13,,,,,,,,,,13,13,,13,13,,13,13],[2,,13,,,,,,,,13,,,,,,,,13,,,,,,,,13,,,,,,,,13,,,,,,,,13,,,,,,,,13,,,,,,,,13,,,,,,,,]]],[0,1,2,3,2,3,2,3,2,3,2,3,2,3,2,3,2,3,2],124,];


const pone = [[[,0,80,,.1,.6,2,,,,,,,,,.02,.01],[.3,0,80,,.08,.18,3],[.7,0,22,,.07,.07,2,0,,,.5,.01]],[[[,,15,,18,,,,15,,18,,,,15,,18,,,,,,10,,13,,,,10,,13,,,,10,,13,,,,,,15,,18,,,,15,,18,,,,20,,18,,,,,,10,,13,,,,,,13,,,,,,,,],[1,,15,18,22,25,15,18,22,25,15,18,22,25,15,18,22,25,15,18,22,25,10,13,17,20,10,13,17,20,10,13,17,20,10,13,17,20,10,13,17,20,15,18,22,25,15,18,22,27,15,18,22,25,20,24,27,30,15,18,22,25,10,17,24,29,10,13,17,20,10,17,24,30,30,27,24,22]],[[,,15,,18,,,,15,,18,,,,15,,18,,,,,,10,,13,,,,10,,13,,,,10,,13,,,,,,15,,18,,,,15,,18,,,,20,,18,,,,,,10,,13,,,,,,13,,,,,,,,],[1,,15,18,22,25,15,18,22,25,15,18,22,25,15,18,22,25,15,18,22,25,10,13,17,20,10,13,17,20,10,13,17,20,10,13,17,20,10,13,17,20,15,18,22,25,15,18,22,27,15,18,22,25,20,24,27,30,15,18,22,25,10,17,24,29,10,13,17,20,10,17,24,30,30,27,24,22],[2,,15,,18,,,,15,,18,,,,15,,18,,,,,,10,,13,,,,10,,13,,,,10,,13,,,,,,15,,18,,,,15,,18,,,,20,,18,,,,,,10,,13,,,,,,13,,,,,,,,]]],[0,1],140,];

const ptwo = [[[3,0,43,,,.25,,,,,,,,2],[.8,0,2100,,,.2,3,3,,,-400,,,2],[,0,23,,,.2,3,5]],[[[,,20,,,,20,,20,,,,20,,20,,,,20,,,,20,,20,,,,20,,20,,,,20,,,,20,,20,,,,20,,20,,,,20,,,,20,,20,,,,20,,20,,,,],[1,,20,,,,20,,20,,,,20,,20,,,,20,,,,20,,20,,,,20,,20,,,,20,,,,20,,20,,,,20,,20,,,,20,,,,20,,20,,,,20,,20,,,,],[2,-1,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,],[,1,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,]],[[,,20,,,,20,,20,,,,20,,20,,,,20,,,,20,,20,,,,20,,20,,,,20,,,,20,,20,,,,20,,20,,,,20,,,,20,,20,,,,20,,20,,,,],[1,,20,,,,20,,20,,,,20,,20,,,,20,,,,20,,20,,,,20,,20,,,,20,,,,20,,20,,,,20,,20,,,,20,,,,20,,20,,,,20,,20,,,,],[2,,13,,13,,13,,13,,13,,13,,13,,16,,13,,13,,13,,13,,13,,13,,13,,16,,13,,13,,13,,13,,13,,13,,13,,16,,13,,13,,13,,13,,13,,16,,18,,19,,],[,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,]]],[1],120,];

export class Songs {
  constructor() {
	this.is_playing = false;
	this.intro = zzfxM(...intro);
	this.pone = zzfxM(...pone);
	this.ptwo = zzfxM(...ptwo);
  }

  play_intro() {
	if(this.audio_node) {
	  this.audio_node.stop();
	}
	this.audio_node = zzfxP(...this.intro);
  }

  play_pone() {
	if(this.audio_node) {
	  this.audio_node.stop();
	}
	this.audio_node = zzfxP(...this.pone);
	this.audio_node.loop = true;
  }

  play_ptwo() {
	if(this.audio_node) {
	  this.audio_node.stop();
	}
	this.audio_node = zzfxP(...this.ptwo);
	this.audio_node.loop = true;
  }

  stop_song() {
	if(this.audio_node) {
	  this.audio_node.stop();
	}
  }

  set_sound_level(level) {
	zzfxV = level;
  }
}
